<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI èŠå¤©ç½‘ç«™ (å¤šä¼šè¯ç‰ˆ)</title>

<!-- Markdown & é«˜äº® -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

<style>
body {
  background: linear-gradient(135deg, #667eea, #764ba2);
  font-family: "Segoe UI", sans-serif;
  margin: 0; display: flex; height: 100vh;
}
.sidebar {
  width: 260px; background: #fff;
  border-right: 1px solid #ddd; display: flex;
  flex-direction: column;
}
.sidebar-header {
  padding: 15px; font-weight: bold; background: #f2f2f2;
  display: flex; justify-content: space-between; align-items: center;
}
.chat-list {
  flex: 1; overflow-y: auto;
}
.chat-item {
  padding: 10px 14px; cursor: pointer;
  border-bottom: 1px solid #eee;
}
.chat-item.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}
.new-chat {
  padding: 10px; text-align: center;
  background: #667eea; color: white;
  cursor: pointer;
}
.chat-container {
  flex: 1; display: flex; flex-direction: column;
  background: white;
}
.header {
  padding: 10px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; display: flex;
  justify-content: space-between; align-items: center;
}
select, input {
  padding: 4px 6px; border-radius: 6px; border: none; outline: none;
}
.chat-messages {
  flex: 1; overflow-y: auto;
  padding: 20px; background: #f7f7f7;
}
.message { margin-bottom: 12px; }
.user .message-content { background: #667eea; color: white; text-align: right; }
.assistant .message-content { background: #fff; color: #333; }
.message-content {
  display: inline-block; max-width: 80%;
  padding: 10px 14px; border-radius: 10px;
  white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.chat-input {
  display: flex; padding: 10px; border-top: 1px solid #ddd;
}
#messageInput { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
#sendButton { margin-left: 10px; background: #667eea; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; }
</style>
</head>

<body>
<div class="sidebar">
  <div class="sidebar-header">
    <span>ğŸ’¬ ä¼šè¯åˆ—è¡¨</span>
    <button id="deleteChat" title="åˆ é™¤å½“å‰ä¼šè¯">ğŸ—‘ï¸</button>
  </div>
  <div class="chat-list" id="chatList"></div>
  <div class="new-chat" id="newChat">â• æ–°å»ºä¼šè¯</div>
</div>

<div class="chat-container">
  <div class="header">
    <div>
      <select id="modelSelect">
        <option value="claude-sonnet-4.5">Claude Sonnet 4.5</option>
        <option value="gemini-pro-1.5">Gemini Pro 1.5</option>
        <option value="gpt-4o">GPT-4o</option>
        <option value="mistral-7b">Mistral 7B</option>
      </select>
      <input type="text" id="systemPrompt" placeholder="ç³»ç»Ÿæç¤ºè¯" />
    </div>
    <div id="chatTitle">æœªå‘½åä¼šè¯</div>
  </div>

  <div id="chatMessages" class="chat-messages"></div>

  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
    <button id="sendButton">å‘é€</button>
  </div>
</div>

<script>
const chatListEl = document.getElementById('chatList');
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const systemPrompt = document.getElementById('systemPrompt');
const modelSelect = document.getElementById('modelSelect');
const chatTitle = document.getElementById('chatTitle');
const deleteChatBtn = document.getElementById('deleteChat');
const newChatBtn = document.getElementById('newChat');

// ---- æ•°æ®ç»“æ„ ----
let chats = JSON.parse(localStorage.getItem('multiChats') || '{}');
let currentChatId = null;

// ---- æ¸²æŸ“å‡½æ•° ----
function renderChatList() {
  chatListEl.innerHTML = '';
  Object.keys(chats).forEach(id => {
    const div = document.createElement('div');
    div.className = 'chat-item' + (id === currentChatId ? ' active' : '');
    div.textContent = chats[id].title || 'æœªå‘½åä¼šè¯';
    div.onclick = () => switchChat(id);
    chatListEl.appendChild(div);
  });
}
function renderMessages() {
  chatMessages.innerHTML = '';
  const chat = chats[currentChatId];
  if (!chat) return;
  chatTitle.textContent = chat.title || 'æœªå‘½åä¼šè¯';
  modelSelect.value = chat.model_id;
  systemPrompt.value = chat.system_prompt;
  chat.history.forEach(msg => addMessage(msg.content, msg.role));
}
function addMessage(content, role) {
  const div = document.createElement('div');
  div.className = `message ${role}`;
  const inner = document.createElement('div');
  inner.className = 'message-content';
  inner.innerHTML = marked.parse(content);
  div.appendChild(inner);
  chatMessages.appendChild(div);
  chatMessages.scrollTo({top: chatMessages.scrollHeight, behavior: 'smooth'});
  hljs.highlightAll();
}

// ---- ä¼šè¯æ§åˆ¶ ----
function newChat() {
  const id = 'chat-' + Date.now();
  chats[id] = {
    title: 'æ–°ä¼šè¯ ' + new Date().toLocaleTimeString(),
    model_id: 'claude-sonnet-4.5',
    system_prompt: '',
    history: []
  };
  currentChatId = id;
  saveChats();
  renderChatList(); renderMessages();
}
function switchChat(id) {
  currentChatId = id;
  saveChats();
  renderChatList(); renderMessages();
}
function deleteChat() {
  if (!currentChatId) return;
  if (confirm('ç¡®å®šåˆ é™¤è¯¥ä¼šè¯å—ï¼Ÿ')) {
    delete chats[currentChatId];
    currentChatId = Object.keys(chats)[0] || null;
    saveChats();
    renderChatList(); renderMessages();
  }
}
function saveChats() {
  localStorage.setItem('multiChats', JSON.stringify(chats));
}

// ---- èŠå¤©åŠŸèƒ½ ----
async function sendMessage() {
  const msg = messageInput.value.trim();
  if (!msg || !currentChatId) return;
  addMessage(msg, 'user');
  const chat = chats[currentChatId];
  chat.history.push({role:'user', content:msg});
  chat.model_id = modelSelect.value;
  chat.system_prompt = systemPrompt.value;
  messageInput.value = '';

  const payload = {
    message: msg,
    model_id: chat.model_id,
    system_prompt: chat.system_prompt,
    history: chat.history
  };
  const res = await fetch('/api/chat', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  const reply = data.message || 'ï¼ˆæ— å“åº”ï¼‰';
  addMessage(reply, 'assistant');
  chat.history.push({role:'assistant', content:reply});
  saveChats();
}

// ---- åˆå§‹åŒ– ----
newChatBtn.onclick = newChat;
deleteChatBtn.onclick = deleteChat;
sendButton.onclick = sendMessage;
messageInput.onkeypress = e => { if (e.key==='Enter') sendMessage(); };

if (Object.keys(chats).length === 0) newChat();
else { currentChatId = Object.keys(chats)[0]; renderChatList(); renderMessages(); }
</script>
</body>
</html>
